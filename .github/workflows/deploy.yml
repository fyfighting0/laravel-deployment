# ============================================================================
# GitHub Actions 工作流配置 - Release 到 ECS
# ============================================================================
# 
# 使用前需要配置以下 GitHub Secrets（在仓库 Settings > Secrets and variables > Actions）:
#   1. AWS_ACCESS_KEY_ID      - AWS 访问密钥 ID
#   2. AWS_SECRET_ACCESS_KEY  - AWS 密钥
#   3. SNS_TOPIC_ARN          - SNS Topic ARN（用于发送通知）
#
# 需要修改的参数（见下方 env 部分）:
#   - AWS_REGION              - AWS 区域
#   - ECR_REPOSITORY          - ECR 仓库名称
#   - ECS_SERVICE             - ECS 服务名称
#   - ECS_CLUSTER             - ECS 集群名称
# 
# 注意: 此工作流使用 latest 标签，Task Definition 中应配置 latest 标签的镜像
#
# ============================================================================

name: Release to ECS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - closed

env:
  # ============================================
  # 需要修改的参数 - 请根据您的实际环境配置
  # ============================================
  AWS_REGION: ap-northeast-1                    # AWS 区域，例如: ap-northeast-1, us-east-1
  ECR_REPOSITORY: app/laravel-app               # ECR 仓库名称
  ECS_SERVICE: laravel-service                  # ECS 服务名称
  ECS_CLUSTER: laravel-cluster-0                # ECS 集群名称

jobs:
  release:
    name: Release - Build, Push & Deploy
    runs-on: ubuntu-latest
    
    # 只在 main 分支的 push 或合并的 PR 时执行部署
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # 构建 Docker 镜像（只使用 latest 标签）
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          
          # 推送到 ECR
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_OUTPUT

      - name: Force ECS Service Deployment
        id: deploy-ecs
        run: |
          # 强制 ECS Service 重新部署（使用 latest 标签的新镜像）
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          
          # 等待服务稳定
          echo "等待 ECS Service 部署完成..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

      - name: Send SNS Notification (Success)
        if: success()
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          MESSAGE=$'Laravel 应用已成功发布到 ECS\n\n镜像: ${{ steps.build-image.outputs.image }}\n服务: ${{ env.ECS_SERVICE }}\n集群: ${{ env.ECS_CLUSTER }}\n提交: ${{ github.sha }}\n作者: ${{ github.actor }}\n仓库: ${{ github.repository }}\n工作流: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n时间: '"$TIMESTAMP"
          aws sns publish \
            --topic-arn ${{ secrets.SNS_TOPIC_ARN }} \
            --subject "部署成功 - Laravel App Release" \
            --message "$MESSAGE"

      - name: Send SNS Notification (Failure)
        if: failure()
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          MESSAGE=$'Laravel 应用部署失败，请立即检查！\n\n服务: ${{ env.ECS_SERVICE }}\n集群: ${{ env.ECS_CLUSTER }}\n提交: ${{ github.sha }}\n作者: ${{ github.actor }}\n仓库: ${{ github.repository }}\n工作流: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n时间: '"$TIMESTAMP"$'\n\n请检查工作流日志以获取详细错误信息。'
          aws sns publish \
            --topic-arn ${{ secrets.SNS_TOPIC_ARN }} \
            --subject "部署失败告警 - Laravel App Release" \
            --message "$MESSAGE"
        continue-on-error: true

